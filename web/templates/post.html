<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ .Post.Title }}</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,400;0,700;1,300;1,400&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Warna Transparan buat Glass Effect (Sama kayak Index) */
            --bg-body: #121212; 
            --bg-nav: rgba(18, 18, 18, 0.85); 
            --bg-hover: rgba(255, 255, 255, 0.1);
            --border: rgba(255, 255, 255, 0.1); 
            --bg-secondary: rgba(255, 255, 255, 0.05);
            
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --text-muted: #757575;
            
            --accent: #a882ff;
            --danger: #ff5f5f;
        }

        * { box-sizing: border-box; }

        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-body); 
            color: var(--text-primary);
            margin: 0; padding: 0;
            line-height: 1.6;
            overflow-x: hidden; /* Prevent horizontal scroll */
        }

        /* --- BACKGROUND BLUR EFFECT --- */
        body::before {
            content: "";
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -2;
            background-image: url('https://images.unsplash.com/photo-1618005182384-a83a8bd57fbe?q=80&w=2564&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            filter: blur(20px) brightness(0.4);
            transform: scale(1.1);
        }

        a { text-decoration: none; color: inherit; transition: 0.2s; }

        /* --- NAVBAR (GLASSMOPHISM) --- */
        .navbar {
            height: 57px; width: 100%;
            background-color: var(--bg-nav);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--border);
            position: fixed; top: 0; left: 0; z-index: 1000;
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 24px;
        }
        .brand { 
            font-family: 'JetBrains Mono', monospace; font-weight: 700; 
            font-size: 1.1rem; letter-spacing: -0.5px; cursor: pointer;
        }
        .nav-right { display: flex; align-items: center; gap: 24px; }
        .btn-write {
            display: flex; align-items: center; gap: 8px;
            color: var(--text-secondary); font-size: 0.9rem; font-weight: 400; cursor: pointer;
        }
        .btn-write:hover { color: var(--text-primary); }
        .nav-avatar {
            width: 32px; height: 32px; border-radius: 50%;
            object-fit: cover; cursor: pointer; background: #333;
        }

        /* --- CONTAINER BACA --- */
        .article-container { 
            max-width: 720px; 
            margin: 0 auto; 
            padding: 100px 24px 60px 24px; 
        }

        /* HEADER ARTIKEL */
        .post-title { 
            font-size: 2.8rem; 
            font-weight: 800; 
            color: var(--text-primary);
            margin: 0 0 24px 0; 
            line-height: 1.25;
            letter-spacing: -0.02em;
        }

        /* AUTHOR INFO */
        .author-meta {
            display: flex; align-items: center; gap: 12px;
            margin-bottom: 32px;
        }
        .author-avatar {
            width: 44px; height: 44px; border-radius: 50%;
            object-fit: cover; background: #333;
        }
        .meta-text { display: flex; flex-direction: column; }
        .author-name { 
            font-size: 0.95rem; font-weight: 600; color: var(--text-primary); 
        }
        .post-date { 
            font-size: 0.85rem; color: var(--text-muted); 
            font-family: 'JetBrains Mono', monospace; margin-top: 2px;
        }

        /* HERO IMAGE / COVER */
        .post-cover {
            width: 100%;
            height: auto;
            max-height: 500px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 40px;
            display: block;
            background-color: var(--bg-secondary);
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        /* ISI KONTEN */
        .post-content {
            font-family: 'Merriweather', serif; 
            font-size: 1.15rem;
            color: #e0e0e0;
            line-height: 2; 
            white-space: pre-wrap; 
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }
        
        .post-content p { margin-bottom: 24px; }

        /* FOOTER / ACTIONS */
        .post-footer {
            margin-top: 60px; padding-top: 20px;
            border-top: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
        }
        
        .tags-wrapper {
            display: flex; gap: 8px; flex-wrap: wrap;
        }

        .tag-pill {
            background: rgba(255,255,255,0.08); 
            padding: 6px 16px; border-radius: 100px; 
            font-size: 0.8rem; color: #ccc;
            border: 1px solid transparent; transition: 0.2s;
        }
        .tag-pill:hover {
            border-color: rgba(255,255,255,0.2); 
            background: rgba(255,255,255,0.15); color: #fff;
        }
        
        /* Action Buttons (Delete, Comment, Bookmark) */
        .action-group {
            display: flex; gap: 16px; align-items: center;
        }

        .icon-btn { 
            background: none; border: none; padding: 0; cursor: pointer; display: flex; 
        }
        .icon-img { 
            width: 24px; height: 24px; opacity: 0.7; filter: invert(1); transition: 0.2s; 
        }
        .icon-btn:hover .icon-img { opacity: 1; }
        .icon-btn.active .icon-img { 
            filter: invert(0.5) sepia(1) saturate(5) hue-rotate(230deg); opacity: 1; 
        }

        .btn-delete {
            background: none; border: none;
            color: var(--danger);
            font-family: 'JetBrains Mono', monospace; font-size: 0.85rem;
            cursor: pointer; opacity: 0.7; transition: 0.2s;
        }
        .btn-delete:hover { opacity: 1; text-decoration: underline; }

    </style>
</head>
<body>

    <header class="navbar">
        <a href="/" class="brand">Ê•â€¢á´¥â€¢Ê” kuma</a>
        
        <div class="nav-right">
            <div class="btn-write" onclick="location.href='/create'">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                Write
            </div>

            {{ if .IsLoggedIn }}
                {{ if .UserAvatar }}
                    <img src="{{ .UserAvatar }}" class="nav-avatar" onclick="location.href='/profile'">
                {{ else }}
                    <div class="nav-avatar" onclick="location.href='/profile'" style="display:flex; align-items:center; justify-content:center; color:#fff;">?</div>
                {{ end }}
            {{ else }}
                <a href="/login" style="font-weight: 700; color: var(--accent);">Login</a>
            {{ end }}
        </div>
    </header>

    <article class="article-container">
        
        <h1 class="post-title">{{ .Post.Title }}</h1>
        
        <div class="author-meta">
            {{ if .Post.User.Avatar }}
                <img src="{{ .Post.User.Avatar }}" class="author-avatar" onclick="location.href='/profile?id={{ .Post.User.ID }}'" style="cursor:pointer;">
            {{ else }}
                <div class="author-avatar" style="display:flex; align-items:center; justify-content:center;">?</div>
            {{ end }}
            
            <div class="meta-text">
                <a href="/profile?id={{ .Post.User.ID }}" class="author-name">{{ .Post.User.Name }}</a>
                <span class="post-date">{{ .Post.CreatedAt.Format "Jan 02, 2006" }} Â· 5 min read</span>
            </div>
        </div>

        {{ if .Post.Image }}
            <img src="{{ .Post.Image }}" alt="Cover Image" class="post-cover">
        {{ end }}

        <div class="post-content">
            {{ .Post.Content }}
        </div>

        <div class="post-footer">
            
            <div class="tags-wrapper">
                {{ range .Post.Tags }}
                    <span class="tag-pill">{{ . }}</span>
                {{ else }}
                    <span class="tag-pill">#story</span>
                {{ end }}
            </div>

            <div class="action-group">
                <button class="icon-btn" onclick="openSidebar('{{ .Post.ID }}')">
                    <img src="/static/images/Comment-2.svg" class="icon-img" title="Comments">
                </button>

                <button class="icon-btn {{ if .Post.IsBookmarked }}active{{ end }}" onclick="toggleIcon(this, '{{ .Post.ID }}')">
                    <img 
                        src="{{ if .Post.IsBookmarked }}/static/images/Bookmark-3.svg{{ else }}/static/images/Bookmark-2.svg{{ end }}" 
                        data-default="/static/images/Bookmark-2.svg" 
                        data-active="/static/images/Bookmark-3.svg" 
                        class="icon-img"
                        title="Bookmark"
                    >
                </button>

                {{ if .IsOwnPost }}
                    <button class="btn-delete" onclick="deletePost('{{ .Post.ID }}')">[ Delete ]</button>
                {{ end }}
            </div>
        </div>

    </article>

    <div id="overlay" onclick="closeSidebar()" style="
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.5); z-index: 2000;
        opacity: 0; visibility: hidden; transition: 0.3s;
        backdrop-filter: blur(2px);
    "></div>

    <div id="commentSidebar" style="
        position: fixed; top: 0; right: -480px; width: 450px; height: 100%;
        background: #1a1a1a; z-index: 2001;
        border-left: 1px solid var(--border);
        transition: right 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        display: flex; flex-direction: column;
        box-shadow: -10px 0 30px rgba(0,0,0,0.5);
    ">
        <div style="padding: 24px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center;">
            <h3 style="margin: 0; font-size: 1.2rem;">Responses (<span id="commentCount">0</span>)</h3>
            <button onclick="closeSidebar()" style="background:none; border:none; color:white; cursor:pointer; font-size: 1.5rem;">&times;</button>
        </div>

        <div id="commentList" style="flex: 1; overflow-y: auto; padding: 24px; display: flex; flex-direction: column; gap: 24px;">
            <div style="text-align: center; color: #777;">Loading...</div>
        </div>

        <div style="padding: 24px; border-top: 1px solid var(--border); background: #1a1a1a;">
            {{ if .IsLoggedIn }}
                <textarea id="commentInput" placeholder="What are your thoughts?" rows="3" style="
                    width: 100%; background: #2a2a2a; border: none; padding: 12px;
                    color: white; border-radius: 8px; resize: none; font-family: inherit;
                    margin-bottom: 12px; outline: none;
                "></textarea>
                <button onclick="submitComment()" style="
                    background: var(--accent); color: white; border: none;
                    padding: 8px 16px; border-radius: 20px; font-weight: 600; cursor: pointer; float: right;
                ">Respond</button>
            {{ else }}
                <a href="/login" style="color: var(--accent); font-weight: 600; display: block; text-align: center;">Login to respond</a>
            {{ end }}
        </div>
    </div>

    <script>
        // --- LOGIC DELETE ---
        async function deletePost(id) {
            if (!confirm("Yakin mau hapus cerita ini? Gak bisa balik lho.")) return;

            try {
                const response = await fetch('/api/posts/' + id, { method: 'DELETE' });
                if (response.ok) {
                    window.location.href = "/";
                } else {
                    const data = await response.json();
                    alert("Gagal hapus: " + data.message);
                }
            } catch (e) {
                alert("Error koneksi server.");
            }
        }

        // --- LOGIC BOOKMARK ---
        async function toggleIcon(btn, postID) {
            btn.classList.toggle('active');
            let isActive = btn.classList.contains('active');
            let img = btn.querySelector('img');
            
            if (isActive) img.src = img.getAttribute('data-active');
            else img.src = img.getAttribute('data-default');
            
            img.style.transform = "scale(1.2)";
            setTimeout(() => { img.style.transform = "scale(1)"; }, 150);

            try {
                const response = await fetch('/api/bookmarks/' + postID, { method: 'POST' });
                if (!response.ok) {
                    alert("Gagal bookmark. Login dulu.");
                    btn.classList.toggle('active');
                    if (!isActive) img.src = img.getAttribute('data-active');
                    else img.src = img.getAttribute('data-default');
                }
            } catch (error) {
                console.error("Error:", error);
            }
        }

        // --- LOGIC SIDEBAR COMMENTS ---
        let currentPostID = 0;

        async function openSidebar(postID) {
            currentPostID = postID;
            
            // UI Muncul
            document.getElementById('commentSidebar').style.right = '0';
            document.getElementById('overlay').style.visibility = 'visible';
            document.getElementById('overlay').style.opacity = '1';
            
            // Reset List
            const list = document.getElementById('commentList');
            list.innerHTML = '<div style="text-align:center; color:#777; margin-top:20px;">Loading thoughts...</div>';

            // Fetch Data
            try {
                const res = await fetch(`/api/comments/${postID}`);
                const comments = await res.json();
                
                document.getElementById('commentCount').innerText = comments.length;
                list.innerHTML = '';

                if(comments.length === 0) {
                    list.innerHTML = '<div style="text-align:center; color:#555; margin-top:40px;">No thoughts yet. Be the first! ðŸŒ¿</div>';
                    return;
                }

                comments.forEach(c => {
                    const avatar = c.user.avatar || 'https://api.dicebear.com/9.x/micah/svg?seed=' + c.user.name;
                    const date = new Date(c.created_at).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    
                    const html = `
                        <div style="border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 16px;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                                <img src="${avatar}" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;">
                                <div>
                                    <div style="font-size: 0.9rem; font-weight: 600;">${c.user.name}</div>
                                    <div style="font-size: 0.75rem; color: #777;">${date}</div>
                                </div>
                            </div>
                            <div style="font-size: 0.95rem; color: #ddd; line-height: 1.5; white-space: pre-wrap;">${c.content}</div>
                        </div>
                    `;
                    list.innerHTML += html;
                });

            } catch (e) {
                console.error(e);
                list.innerHTML = '<div style="color:red; text-align:center;">Failed to load comments.</div>';
            }
        }

        function closeSidebar() {
            document.getElementById('commentSidebar').style.right = '-480px';
            document.getElementById('overlay').style.opacity = '0';
            setTimeout(() => {
                document.getElementById('overlay').style.visibility = 'hidden';
            }, 300);
        }

        async function submitComment() {
            const input = document.getElementById('commentInput');
            const content = input.value.trim();
            if(!content) return;

            const btn = document.querySelector('#commentSidebar button');
            const oldText = btn.innerText;
            btn.innerText = "Posting...";
            btn.disabled = true;

            try {
                const res = await fetch('/api/comments', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ post_id: parseInt(currentPostID), content: content })
                });

                if(res.ok) {
                    input.value = '';
                    openSidebar(currentPostID); // Refresh list
                } else {
                    alert("Gagal kirim komentar.");
                }
            } catch (e) {
                alert("Error koneksi.");
            }

            btn.innerText = oldText;
            btn.disabled = false;
        }
    </script>

</body>
</html>